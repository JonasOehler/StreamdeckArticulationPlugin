<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Cubase Command – Property Inspector</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="sdpi.css" />
    <style>
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .hidden {
        display: none;
      }
      select,
      input {
        width: 100%;
      }
      .muted {
        opacity: 0.8;
        font-size: 12px;
        margin-top: 6px;
        grid-column: 1/-1;
      }
    </style>
  </head>
  <body>
    <div class="sdpi-wrapper">
      <div class="sdpi-heading">Cubase Command (2 States)</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Preset</div>
        <select class="sdpi-item-value" id="preset"></select>
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">Modus</div>
        <select class="sdpi-item-value" id="mode">
          <option value="momentary">Momentary</option>
          <option value="toggle">Toggle</option>
        </select>
      </div>

      <div class="sdpi-heading">MIDI</div>
      <div class="grid">
        <div class="sdpi-item">
          <div class="sdpi-item-label">Channel (0–15)</div>
          <input type="number" id="channel" min="0" max="15" />
        </div>
        <div class="sdpi-item" id="rowController">
          <div class="sdpi-item-label">Controller (0–127)</div>
          <input type="number" id="controller" min="0" max="127" />
        </div>
      </div>

      <div class="muted">
        Slots 1–32 entsprechen CC 10–41 auf Kanal 13 (zero-based).<br />
        Im Cubase <i>Mapping-Assistenten</i> weist du die Slots beliebigen
        Befehlen zu.
      </div>
    </div>

    <script>
      let uuid = null,
        action = null,
        websocket = null,
        settings = {};

      const $ = (id) => document.getElementById(id);
      const els = {
        preset: $("preset"),
        mode: $("mode"),
        channel: $("channel"),
        controller: $("controller"),
        rowController: $("rowController"),
      };

      // Preset-Liste: slot1..slot32 + custom
      function fillPresetOptions() {
        const frag = document.createDocumentFragment();
        for (let i = 1; i <= 32; i++) {
          const opt = document.createElement("option");
          opt.value = `slot${i}`;
          opt.textContent = `Slot ${i} (CC ${10 + (i - 1)})`;
          frag.appendChild(opt);
        }
        const oc = document.createElement("option");
        oc.value = "custom";
        oc.textContent = "Custom CC";
        frag.appendChild(oc);
        els.preset.innerHTML = "";
        els.preset.appendChild(frag);
      }

      // SD Boilerplate
      function connectElgatoStreamDeckSocket(
        inPort,
        inUUID,
        inRegisterEvent,
        inInfo,
        inAction
      ) {
        uuid = inUUID;
        action = inAction;
        websocket = new WebSocket("ws://127.0.0.1:" + inPort);
        websocket.onopen = function () {
          websocket.send(JSON.stringify({ event: inRegisterEvent, uuid }));
          requestSettings();
        };
        websocket.onmessage = function (evt) {
          const msg = JSON.parse(evt.data);
          if (msg.event === "didReceiveSettings") {
            settings = msg.payload.settings || {};
            populateForm(settings);
          }
        };
      }

      function requestSettings() {
        websocket.send(JSON.stringify({ event: "getSettings", context: uuid }));
      }
      function saveSettings() {
        websocket.send(
          JSON.stringify({
            event: "setSettings",
            context: uuid,
            payload: settings,
          })
        );
      }

      const SLOT_BASE_CC = 10;
      function ccForSlot(slot) {
        const n = Math.max(1, Math.min(32, Number(slot) || 1));
        return SLOT_BASE_CC + (n - 1);
      }

      function populateForm(s) {
        const preset = s.preset || "slot1";
        els.preset.value = preset;

        const isSlot = /^slot([1-9]|[12]\d|3[0-2])$/.test(preset);
        const slotNo = isSlot ? Number(preset.replace("slot", "")) : 1;

        const mode = s.mode || "momentary";
        els.mode.value = mode;

        els.channel.value = s.channel != null ? s.channel : 13;
        if (isSlot) els.rowController.classList.add("hidden");
        else els.rowController.classList.remove("hidden");
        els.controller.value =
          s.controller != null ? s.controller : isSlot ? ccForSlot(slotNo) : 10;
      }

      function applyPreset(preset) {
        const isSlot = /^slot([1-9]|[12]\d|3[0-2])$/.test(preset);
        const slotNo = isSlot ? Number(preset.replace("slot", "")) : 1;

        settings = {
          ...settings,
          preset,
          mode: settings.mode || "momentary",
          channel: settings.channel != null ? settings.channel : 13,
          controller: isSlot ? ccForSlot(slotNo) : settings.controller ?? 10,
        };
        populateForm(settings);
        saveSettings();
      }

      // UI
      fillPresetOptions();
      els.preset.oninput = (e) => applyPreset(e.target.value);
      els.mode.oninput = () => {
        saveFromForm();
      };
      els.channel.oninput = saveFromForm;
      els.controller.oninput = saveFromForm;

      function saveFromForm() {
        const preset = els.preset.value;
        const isSlot = /^slot([1-9]|[12]\d|3[0-2])$/.test(preset);
        const slotNo = isSlot ? Number(preset.replace("slot", "")) : 1;

        settings.preset = preset;
        settings.mode = els.mode.value;
        settings.channel = clamp(parseInt(els.channel.value, 10), 0, 15);
        settings.controller = isSlot
          ? ccForSlot(slotNo)
          : clamp(parseInt(els.controller.value, 10), 0, 127);

        populateForm(settings);
        saveSettings();
      }
      function clamp(n, a, b) {
        n = isFinite(n) ? n : a;
        return Math.max(a, Math.min(b, n));
      }
    </script>
  </body>
</html>
